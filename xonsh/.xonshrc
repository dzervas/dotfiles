from datetime import datetime
from xonsh.base_shell import print_color
from xonsh.prompt.gitstatus import gitstatus_prompt
import re

def gitprompt():
	if gitstatus_prompt():
		return "Â±{INTENSE_GREEN}[" + gitstatus_prompt() + "{INTENSE_GREEN}]"

def jobsprompt():
	jobs = $(jobs).splitlines()
	jobs = len(jobs) - 1

	if jobs > 0:
		return "{{INTENSE_GREEN}}[{{INTENSE_CYAN}}J{}{{INTENSE_GREEN}}]".format(jobs)

def mkcd(args, stdin=None):
	mkdir @(args[0])
	cd @(args[0])

def stackadd(args, stdin=None):
	now = datetime.now()
	with open($HOME + "/.stack", "a") as fp:
		fp.write(now.strftime("[%d/%m %I:%M]") + " " + " ".join(args) + "\n")

def stackcount(args=None, stdin=None):
	if args == None:
		return len(stacklist())

	print(len(stacklist()))

def stacklist(args=None, stdin=None):
	search = r"^(\[.*\])"
	replace = r"{INTENSE_GREEN}\1{NO_COLOR}"
	result = []

	with open($HOME + "/.stack") as fp:
		for line in fp:
			result.append(re.sub(search, replace, line.strip()))
	
	result.reverse()

	if args == None:
		return result

	for line in result:
		print_color(line)

def stackprompt():
	if stackcount() > 0:
		return " {{BOLD_INTENSE_RED}}{}".format(stackcount())

def stackremove(args, stdin=None):
	with open($HOME + "/.stack") as fin:
		data = fin.read().splitlines()
	with open($HOME + "/.stack", "w") as fout:
		fout.write("\n".join(data[:-1]))

def todirprompt():
	count = $(todir -c)
	if not count:
		return ""

	count = int(count)
	if count > 0:
		return "{{INTENSE_GREEN}}[{{INTENSE_YELLOW}}T{}{{INTENSE_GREEN}}]".format(count)

$FORMATTER_DICT["git"] = gitprompt
$FORMATTER_DICT["jobs"] = jobsprompt
$FORMATTER_DICT["stack"] = stackprompt
$FORMATTER_DICT["todir"] = todirprompt

aliases["mc"]=mkcd
aliases["sc"]=stackcount
aliases["sl"]=stacklist

aliases["++"]=stackadd
aliases["--"]=stackremove
aliases["8ping"]="ping 8.8.8.8"
aliases["diff"]="colordiff -ub"
aliases["docker_rm"]="docker rm $(docker ps --no-trunc -aqf status=exited)"
aliases["docker_rmi"]="docker rmi $(docker images --no-trunc -qf dangling=true)"
aliases["e"]="${EDITOR}"
aliases["es"]="${EDITOR} ~/.stack"
aliases["et"]="${EDITOR} .todir"
aliases["g"]="git"
aliases["grep"]="grep --color"
aliases["l"]="ls --color=auto"
aliases["less"]="less -R"
aliases["ll"]="ls -hal --color=auto"
aliases["ls"]="ls --color=auto"
aliases["passgen"]="gpg --gen-random --armor 1 "
aliases["pgrep"]="pgrep -a"
aliases["py"]="python"
aliases["py2"]="python2"
aliases["ss"]="import /tmp/screenshot.jpg"
aliases["ssall"]="import -window root /tmp/screenshot.jpg"
aliases["ssh"]="TERM=xterm-256color ssh"
aliases["t"]="todir"
aliases["v"]="nvim"
aliases["vt"]="nvim .todir"
aliases["vs"]="nvim ~/.stack"
aliases["webserver"]="python2 -m SimpleHTTPServer"
aliases[":q"]="exit"
aliases[";q"]="exit"
